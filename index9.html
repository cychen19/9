import React, { useState, useEffect, useMemo } from 'react';
import { 
  LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
  PieChart, Pie, Cell, AreaChart, Area, BarChart, Bar, Legend, ComposedChart
} from 'recharts';
import { 
  Wallet, TrendingUp, Upload, Calculator, 
  Plus, Trash2, Edit2, FileSpreadsheet,
  ArrowUpRight, ArrowDownRight, LayoutDashboard,
  DollarSign, Calendar, X, Save, Clock, Moon, PieChart as PieChartIcon, 
  Database, RefreshCw, Activity, Award, AlertTriangle, Search
} from 'lucide-react';

// --- 專業經理人點評數據庫 (Manager's Reviews) ---
const STOCK_REVIEWS = {
  '00631L': {
    rating: 4.5,
    risk: '高',
    comment: '最強大的台股槓桿工具。利用每日兩倍槓桿追蹤 0050，在長期多頭市場具有驚人的複利爆發力。但需注意「波動耗損」，盤整期會吃掉獲利。適合心臟大顆的長期信仰者。',
    tag: '槓桿/成長'
  },
  '00757': {
    rating: 5.0,
    risk: '高',
    comment: '集中持有美國十大科技巨頭 (FANG+)，是攻擊力最強的 ETF 之一。雖波動劇烈，但只要相信 AI 與科技是未來主軸，這支就是核心配置。費用率略高是唯一缺點。',
    tag: '美股/科技'
  },
  '00981': {
    rating: 3.5,
    risk: '中',
    comment: '追蹤美國大型股，性質接近 S&P 500 但更聚焦。表現中規中矩，適合作為資產配置的基底，但在攻擊力上不如 QQQ 或 00757。',
    tag: '美股/平衡'
  },
  '2002': {
    rating: 2.5,
    risk: '中',
    comment: '典型的景氣循環股。中鋼的獲利高度依賴原物料報價與全球景氣。除非您是為了領紀念品或極低點佈局，否則以「資產增值」角度來看，效率遠低於大盤指數。建議換股操作。',
    tag: '傳產/循環'
  },
  '2330': {
    rating: 5.0,
    risk: '中高',
    comment: '全球半導體王者，擁有不可撼動的技術護城河 (Moat)。在 AI 時代是絕對的軍火商。雖然股價已高，但獲利成長性依然強勁。值得長期持有做為核心資產。',
    tag: '半導體/核心'
  },
  '3033': {
    rating: 3.0,
    risk: '中',
    comment: '電子通路商，獲利穩定且殖利率不錯。這類股票適合退休族群領息，但對於追求資產翻倍的成長期投資人來說，爆發力不足。',
    tag: '高息/通路'
  },
  'COST': {
    rating: 5.0,
    risk: '中',
    comment: '零售業的奇蹟。會員制帶來的穩定現金流與極高的客戶忠誠度，使其成為最具防禦力的成長股。即便在經濟衰退期也能表現優異。極品。',
    tag: '美股/護城河'
  },
  'QQQ': {
    rating: 4.8,
    risk: '中高',
    comment: '那斯達克 100 指數。無需多言，這是過去 20 年全球表現最好的指數之一。包含了所有改變人類生活的科技公司。年輕人資產配置的首選。',
    tag: '美股/指數'
  },
  'NFLX': {
    rating: 4.0,
    risk: '高',
    comment: '串流影音霸主。雖然面臨競爭，但其定價權與原創內容能力依然強大。需留意訂戶成長天花板與內容製作成本。屬高波動成長股。',
    tag: '美股/媒體'
  },
  'FNGS': {
    rating: 4.8,
    risk: '極高',
    comment: '與 00757 相似的 ETN 產品。集中度極高，成也蕭何敗也蕭何。注意 ETN 有發行商信用風險（雖然 BMO 倒閉機率低），且 2038 年到期。攻擊型武器。',
    tag: '美股/ETN'
  },
  'XLG': {
    rating: 4.2,
    risk: '中',
    comment: 'S&P 500 前 50 大巨頭。比一般 S&P 500 更集中於強勢股，績效通常較好。適合覺得 QQQ 波動太大，但又嫌 SPY 太溫吞的中庸投資者。',
    tag: '美股/大型'
  },
};

// --- 市場數據 (含歷史年化報酬 CAGR) ---
const MARKET_DATA = {
  // 台股
  '00631L': { price: 348.85, name: '元大台灣50正2', currency: 'TWD', cagr: 25.5 }, 
  '00757': { price: 121.85, name: '統一FANG+', currency: 'TWD', cagr: 22.0 }, 
  '00981': { price: 11.72, name: '統一美國50', currency: 'TWD', cagr: 12.0 },
  '2002': { price: 18.75, name: '中鋼', currency: 'TWD', cagr: 3.5 }, 
  '2330': { price: 1480.00, name: '台積電', currency: 'TWD', cagr: 18.5 },
  '3033': { price: 30.85, name: '威健', currency: 'TWD', cagr: 6.0 },
  // 美股
  'COST': { price: 884.48, name: 'Costco Wholesale', currency: 'USD', cagr: 14.5 },
  'QQQ': { price: 625.58, name: 'Invesco QQQ', currency: 'USD', cagr: 16.8 }, 
  'NFLX': { price: 94.60, name: 'Netflix', currency: 'USD', cagr: 15.0 }, 
  'FNGS': { price: 71.60, name: 'MicroSectors FANG+', currency: 'USD', cagr: 20.0 }, 
  'XLG': { price: 59.68, name: 'Invesco S&P 500 Top 50', currency: 'USD', cagr: 11.5 },
};

const EXCHANGE_RATE = 32.5;

function useStickyState(defaultValue, key) {
  const [value, setValue] = useState(() => {
    const stickyValue = window.localStorage.getItem(key);
    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
  });
  useEffect(() => {
    window.localStorage.setItem(key, JSON.stringify(value));
  }, [key, value]);
  return [value, setValue];
}

const formatMoney = (amount, currency = 'TWD') => {
  return new Intl.NumberFormat('zh-TW', { 
    style: 'currency', 
    currency: currency, 
    maximumFractionDigits: 0 
  }).format(amount);
};

// --- 子組件 ---

const Dashboard = ({ assets, onUpdateAsset, onDeleteAsset, onAddAsset }) => {
  const [isAddModalOpen, setIsAddModalOpen] = useState(false);
  const [editingAsset, setEditingAsset] = useState(null);

  const { totalMarketValueTWD, totalCostTWD } = useMemo(() => {
    let marketVal = 0;
    let costVal = 0;
    assets.forEach(asset => {
      const data = MARKET_DATA[asset.ticker] || { price: asset.cost, currency: 'TWD' };
      const mVal = data.price * asset.shares;
      const cVal = asset.cost * asset.shares;
      if (data.currency === 'USD') {
        marketVal += mVal * EXCHANGE_RATE;
        costVal += cVal * EXCHANGE_RATE;
      } else {
        marketVal += mVal;
        costVal += cVal;
      }
    });
    return { totalMarketValueTWD: marketVal, totalCostTWD: costVal };
  }, [assets]);

  const totalPnL = totalMarketValueTWD - totalCostTWD;
  const pnlPercent = totalCostTWD > 0 ? (totalPnL / totalCostTWD) * 100 : 0;

  const pieData = useMemo(() => {
    const data = assets.map(asset => {
      const info = MARKET_DATA[asset.ticker] || { price: asset.cost, currency: 'TWD' };
      let value = info.price * asset.shares;
      if (info.currency === 'USD') value *= EXCHANGE_RATE;
      return { name: asset.ticker, value };
    }).sort((a, b) => b.value - a.value);
    
    if (data.length > 5) {
      const top5 = data.slice(0, 5);
      const others = data.slice(5).reduce((sum, item) => sum + item.value, 0);
      return [...top5, { name: '其他', value: others }];
    }
    return data;
  }, [assets]);

  const COLORS = ['#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#EC4899', '#6B7280'];

  return (
    <div className="space-y-6 animate-in fade-in duration-500 pb-20 relative min-h-screen">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-gray-800 border border-gray-700 p-6 rounded-2xl relative overflow-hidden">
          <div className="absolute top-0 right-0 p-4 opacity-10"><Wallet size={64} /></div>
          <p className="text-gray-400 text-sm font-medium mb-1">總資產淨值 (TWD)</p>
          <h3 className="text-3xl font-bold text-white tracking-tight">{formatMoney(totalMarketValueTWD)}</h3>
          <div className="mt-4 flex flex-wrap gap-2 text-xs">
             <span className="bg-emerald-900/30 text-emerald-300 px-2 py-1 rounded flex items-center border border-emerald-500/20">
               <Database size={12} className="mr-1"/> 本地自動儲存
             </span>
             <span className="bg-blue-900/30 text-blue-300 px-2 py-1 rounded flex items-center border border-blue-500/20">
               <RefreshCw size={12} className="mr-1"/> Yahoo 數據連動 (模擬中)
             </span>
          </div>
        </div>

        <div className="bg-gray-800 border border-gray-700 p-6 rounded-2xl">
          <p className="text-gray-400 text-sm font-medium mb-1">未實現損益 (TWD)</p>
          <div className="flex items-baseline gap-2">
            <h3 className={`text-3xl font-bold ${totalPnL >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
              {totalPnL >= 0 ? '+' : ''}{formatMoney(totalPnL)}
            </h3>
          </div>
          <div className={`mt-2 text-sm font-medium ${pnlPercent >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
             總報酬率 {pnlPercent.toFixed(2)}%
          </div>
        </div>

        <div className="bg-gray-800 border border-gray-700 p-6 rounded-2xl flex items-center gap-4">
           <div className="flex-1">
             <p className="text-gray-400 text-sm font-medium mb-2">資產分佈</p>
             <div className="h-24 w-full">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie data={pieData} cx="50%" cy="50%" innerRadius={25} outerRadius={40} paddingAngle={2} dataKey="value">
                      {pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                    </Pie>
                    <Tooltip contentStyle={{backgroundColor: '#1F2937', border: 'none'}} itemStyle={{color: '#fff'}} formatter={(val) => formatMoney(val)}/>
                  </PieChart>
                </ResponsiveContainer>
             </div>
           </div>
           <div className="space-y-1 text-xs text-gray-400">
             {pieData.slice(0,3).map((d, i) => (
               <div key={i} className="flex items-center gap-2">
                 <span className="w-2 h-2 rounded-full" style={{backgroundColor: COLORS[i]}}></span>
                 {d.name}
               </div>
             ))}
           </div>
        </div>
      </div>

      <div className="bg-gray-800 border border-gray-700 rounded-2xl overflow-hidden">
        <div className="px-6 py-4 border-b border-gray-700 flex justify-between items-center">
          <h3 className="font-semibold text-white flex items-center gap-2">
            <LayoutDashboard size={18} className="text-emerald-400"/> 持倉明細
          </h3>
          <span className="text-xs text-gray-500">Auto-Save Enabled</span>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-left">
            <thead className="bg-gray-900/50 text-gray-400 font-medium">
              <tr>
                <th className="px-6 py-4">標的</th>
                <th className="px-6 py-4 text-right">股數</th>
                <th className="px-6 py-4 text-right">成本 (原幣)</th>
                <th className="px-6 py-4 text-right">現價 (Close)</th>
                <th className="px-6 py-4 text-right">市值 (TWD)</th>
                <th className="px-6 py-4 text-right">損益 %</th>
                <th className="px-6 py-4 text-center">編輯/刪除</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-700/50">
              {assets.map((asset) => (
                <StockRow 
                  key={asset.id} 
                  asset={asset} 
                  onDelete={onDeleteAsset} 
                  onEdit={() => setEditingAsset(asset)}
                />
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <button 
        onClick={() => setIsAddModalOpen(true)}
        className="fixed bottom-24 right-6 md:bottom-10 md:right-10 w-14 h-14 bg-emerald-500 hover:bg-emerald-400 text-white rounded-full shadow-lg shadow-emerald-900/50 flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-40"
      >
        <Plus size={28} />
      </button>

      {(isAddModalOpen || editingAsset) && (
        <AssetModal 
          isOpen={true}
          onClose={() => { setIsAddModalOpen(false); setEditingAsset(null); }}
          onSave={(data) => {
            if (editingAsset) {
              onUpdateAsset({ ...editingAsset, ...data });
            } else {
              onAddAsset(data);
            }
            setIsAddModalOpen(false);
            setEditingAsset(null);
          }}
          initialData={editingAsset}
        />
      )}
    </div>
  );
};

const StockRow = ({ asset, onDelete, onEdit }) => {
  const info = MARKET_DATA[asset.ticker] || { price: asset.cost, currency: 'TWD', name: '自訂' };
  
  const marketValRaw = info.price * asset.shares;
  const costValRaw = asset.cost * asset.shares;
  
  const marketValTWD = info.currency === 'USD' ? marketValRaw * EXCHANGE_RATE : marketValRaw;
  const costValTWD = info.currency === 'USD' ? costValRaw * EXCHANGE_RATE : costValRaw;
  
  const gainTWD = marketValTWD - costValTWD;
  const gainPercent = (gainTWD / costValTWD) * 100;

  return (
    <tr className="hover:bg-gray-700/30 transition-colors group">
      <td className="px-6 py-4">
        <div className="flex flex-col">
          <div className="flex items-center gap-2">
            <span className="font-bold text-white">{asset.ticker}</span>
            {info.currency === 'USD' && <span className="text-[10px] bg-blue-900/40 text-blue-300 px-1.5 rounded">美股</span>}
          </div>
          <span className="text-xs text-gray-500">{info.name}</span>
        </div>
      </td>
      <td className="px-6 py-4 text-right text-gray-300">{asset.shares.toLocaleString()}</td>
      <td className="px-6 py-4 text-right text-gray-400">
        {info.currency === 'USD' ? '$' : 'NT$'}{asset.cost.toFixed(2)}
      </td>
      <td className="px-6 py-4 text-right font-mono text-gray-200">
        {info.currency === 'USD' ? '$' : 'NT$'}{info.price.toFixed(2)}
      </td>
      <td className="px-6 py-4 text-right text-white font-medium">
        {formatMoney(marketValTWD)}
      </td>
      <td className="px-6 py-4 text-right">
        <div className={`flex items-center justify-end gap-1 ${gainPercent >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>
          {gainPercent >= 0 ? <ArrowUpRight size={14}/> : <ArrowDownRight size={14}/>}
          {gainPercent.toFixed(2)}%
        </div>
      </td>
      <td className="px-6 py-4 text-center">
        <div className="flex items-center justify-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
          <button onClick={onEdit} className="p-1.5 hover:bg-blue-500/20 text-gray-400 hover:text-blue-400 rounded-md">
            <Edit2 size={16} />
          </button>
          <button onClick={() => onDelete(asset.id)} className="p-1.5 hover:bg-rose-500/20 text-gray-400 hover:text-rose-400 rounded-md">
            <Trash2 size={16} />
          </button>
        </div>
      </td>
    </tr>
  );
};

const AssetModal = ({ isOpen, onClose, onSave, initialData }) => {
  const [formData, setFormData] = useState({
    ticker: initialData?.ticker || '',
    shares: initialData?.shares || '',
    cost: initialData?.cost || '',
  });

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-gray-800 border border-gray-700 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-in zoom-in-95 duration-200">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-white">{initialData ? '編輯持倉' : '新增持倉'}</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-white"><X size={20} /></button>
        </div>
        <div className="space-y-4">
          <div>
            <label className="block text-sm text-gray-400 mb-1">股票代碼 (Ticker)</label>
            <input 
              type="text" 
              placeholder="e.g., 2330, AAPL"
              className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-emerald-500 outline-none uppercase"
              value={formData.ticker}
              onChange={e => setFormData({...formData, ticker: e.target.value.toUpperCase()})}
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-gray-400 mb-1">持有股數</label>
              <input 
                type="number" 
                className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-emerald-500 outline-none"
                value={formData.shares}
                onChange={e => setFormData({...formData, shares: e.target.value})}
              />
            </div>
            <div>
              <label className="block text-sm text-gray-400 mb-1">平均成本 (原幣)</label>
              <input 
                type="number" 
                step="0.01"
                className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-emerald-500 outline-none"
                value={formData.cost}
                onChange={e => setFormData({...formData, cost: e.target.value})}
              />
            </div>
          </div>
          <button 
            onClick={() => onSave({
              ticker: formData.ticker,
              shares: parseFloat(formData.shares),
              cost: parseFloat(formData.cost)
            })}
            className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-3 rounded-xl mt-4 flex items-center justify-center gap-2"
          >
            <Save size={18} /> 儲存變更
          </button>
        </div>
      </div>
    </div>
  );
};

const MonthlyAccounting = ({ records, setRecords }) => {
  const [newRecord, setNewRecord] = useState({ month: '', income: '', expense: '', netWorth: '', note: '' });

  const processedRecords = useMemo(() => {
    const sorted = [...records].sort((a, b) => a.month.localeCompare(b.month));
    return sorted.map((rec, index) => {
      const prev = index > 0 ? sorted[index - 1] : null;
      const incomeGrowth = prev ? ((rec.income - prev.income) / prev.income) * 100 : 0;
      const expenseGrowth = prev ? ((rec.expense - prev.expense) / prev.expense) * 100 : 0;
      return { ...rec, incomeGrowth, expenseGrowth };
    });
  }, [records]);

  const handleAddRecord = () => {
    if (!newRecord.month) return;
    setRecords(prev => [...prev, { 
      id: Date.now(), 
      month: newRecord.month, 
      income: Number(newRecord.income) || 0, 
      expense: Number(newRecord.expense) || 0, 
      netWorth: Number(newRecord.netWorth) || 0,
      note: newRecord.note 
    }]);
    setNewRecord({ month: '', income: '', expense: '', netWorth: '', note: '' });
  };

  const handleDeleteRecord = (id) => {
    setRecords(prev => prev.filter(r => r.id !== id));
  };

  return (
    <div className="max-w-4xl mx-auto space-y-8 animate-in slide-in-from-bottom-4 duration-500">
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h2 className="text-2xl font-bold text-white">每月收支 & 資產戰情</h2>
          <p className="text-gray-400 text-sm">輸入每月結算數據，系統將自動生成資產趨勢線。</p>
        </div>
        
        <div className="bg-gray-800 p-4 rounded-xl border border-gray-700 flex flex-wrap gap-3 items-end w-full md:w-auto">
          <div>
            <label className="block text-xs text-gray-500 mb-1">月份</label>
            <input type="month" min="2025-12" className="bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-sm"
              value={newRecord.month} onChange={e => setNewRecord({...newRecord, month: e.target.value})} />
          </div>
          <div className="w-20">
            <label className="block text-xs text-emerald-500 mb-1">收入</label>
            <input type="number" className="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-sm"
              value={newRecord.income} onChange={e => setNewRecord({...newRecord, income: e.target.value})} />
          </div>
          <div className="w-20">
            <label className="block text-xs text-rose-500 mb-1">支出</label>
            <input type="number" className="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-white text-sm"
              value={newRecord.expense} onChange={e => setNewRecord({...newRecord, expense: e.target.value})} />
          </div>
          <div className="w-28">
            <label className="block text-xs text-blue-400 mb-1 font-bold">當月總資產</label>
            <input type="number" className="w-full bg-gray-900 border border-blue-500/50 rounded px-2 py-1 text-white text-sm"
              value={newRecord.netWorth} onChange={e => setNewRecord({...newRecord, netWorth: e.target.value})} />
          </div>
          <button onClick={handleAddRecord} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-1.5 rounded h-[30px] flex items-center text-sm font-medium transition-colors">
            <Plus size={16} className="mr-1"/> 登記
          </button>
        </div>
      </div>

      <div className="bg-gray-800 border border-gray-700 p-6 rounded-2xl h-[350px]">
        <h3 className="text-white font-medium mb-4 flex items-center gap-2">
          <TrendingUp size={16} className="text-blue-400"/> 資產成長與收支趨勢
        </h3>
        <ResponsiveContainer width="100%" height="100%">
          {processedRecords.length > 0 ? (
            <ComposedChart data={processedRecords}>
              <CartesianGrid strokeDasharray="3 3" stroke="#374151" vertical={false} />
              <XAxis dataKey="month" stroke="#9CA3AF" />
              <YAxis yAxisId="left" stroke="#9CA3AF" />
              <YAxis yAxisId="right" orientation="right" stroke="#60A5FA" />
              <Tooltip contentStyle={{ backgroundColor: '#1F2937', borderColor: '#374151', color: '#fff' }} />
              <Legend />
              <Bar yAxisId="left" dataKey="income" name="收入" fill="#10B981" barSize={20} radius={[4, 4, 0, 0]} />
              <Bar yAxisId="left" dataKey="expense" name="支出" fill="#EF4444" barSize={20} radius={[4, 4, 0, 0]} />
              <Line yAxisId="right" type="monotone" dataKey="netWorth" name="總資產" stroke="#60A5FA" strokeWidth={3} dot={{r: 4}} />
            </ComposedChart>
          ) : (
            <div className="flex items-center justify-center h-full text-gray-500 text-sm">
              尚無數據，請輸入第一筆 2025/12 資料
            </div>
          )}
        </ResponsiveContainer>
      </div>

      <div className="grid gap-4">
        {processedRecords.slice().reverse().map((rec) => (
          <div key={rec.id} className="bg-gray-800/50 border border-gray-700 rounded-xl p-4 flex flex-col md:flex-row items-center justify-between hover:bg-gray-800 transition-colors relative group">
            <button onClick={() => handleDeleteRecord(rec.id)} className="absolute top-2 right-2 text-gray-600 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity">
              <Trash2 size={16}/>
            </button>
            <div className="flex items-center gap-4 mb-4 md:mb-0 w-full md:w-auto">
              <div className="w-12 h-12 bg-gray-700 rounded-lg flex items-center justify-center text-gray-300 font-bold text-xs flex-col">
                <span>{rec.month.split('-')[1]}月</span>
                <span className="text-[10px] opacity-70">{rec.month.split('-')[0]}</span>
              </div>
              <div>
                <div className="text-white font-medium flex items-center gap-2">
                  總資產: <span className="text-blue-400 font-bold text-lg">{formatMoney(rec.netWorth)}</span>
                </div>
                <div className="text-xs text-gray-500">淨流: {formatMoney(rec.income - rec.expense)}</div>
              </div>
            </div>

            <div className="flex gap-6 w-full md:w-auto justify-between md:justify-end px-4 md:px-0">
              <div className="text-right">
                <div className="text-xs text-gray-400">收入</div>
                <div className="text-emerald-400 font-mono">{formatMoney(rec.income)}</div>
                {rec.incomeGrowth !== 0 && (
                  <div className={`text-[10px] ${rec.incomeGrowth > 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                    {rec.incomeGrowth > 0 ? '▲' : '▼'} {Math.abs(rec.incomeGrowth).toFixed(1)}%
                  </div>
                )}
              </div>
              <div className="text-right">
                <div className="text-xs text-gray-400">支出</div>
                <div className="text-rose-400 font-mono">{formatMoney(rec.expense)}</div>
                 {rec.expenseGrowth !== 0 && (
                  <div className={`text-[10px] ${rec.expenseGrowth < 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                    {rec.expenseGrowth > 0 ? '▲' : '▼'} {Math.abs(rec.expenseGrowth).toFixed(1)}%
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// 3. 持倉複利推演 (升級版：含經理人點評)
const CompoundCalc = ({ assets }) => {
  const [selectedAssetId, setSelectedAssetId] = useState('');
  const [years, setYears] = useState(10);
  
  const projection = useMemo(() => {
    if (!selectedAssetId) return null;
    
    const asset = assets.find(a => a.id.toString() === selectedAssetId);
    if (!asset) return null;

    const info = MARKET_DATA[asset.ticker] || { price: asset.cost, cagr: 8, currency: 'TWD' };
    const review = STOCK_REVIEWS[asset.ticker]; // 獲取點評
    
    let initialPrincipal = info.price * asset.shares;
    if (info.currency === 'USD') initialPrincipal *= EXCHANGE_RATE;

    const data = [];
    let current = initialPrincipal;
    
    for(let i = 0; i <= years; i++) {
      data.push({
        year: i,
        amount: Math.round(current),
        principal: Math.round(initialPrincipal)
      });
      current = current * (1 + info.cagr / 100);
    }
    return { data, info, ticker: asset.ticker, review };
  }, [selectedAssetId, years, assets]);

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-in fade-in duration-500">
      <div className="lg:col-span-1 space-y-6 bg-gray-800 border border-gray-700 p-6 rounded-2xl">
        <h3 className="text-xl font-bold text-white mb-4 flex items-center">
          <Calculator className="mr-2 text-emerald-400"/> 持倉推演 & 健診
        </h3>
        
        <div className="space-y-4">
          <div>
            <label className="text-xs text-gray-400 uppercase font-semibold mb-2 block">選擇健診持股</label>
            <div className="relative">
              <Search size={16} className="absolute left-3 top-3 text-gray-500"/>
              <select 
                className="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 pl-10 text-white outline-none appearance-none"
                onChange={(e) => setSelectedAssetId(e.target.value)}
                value={selectedAssetId}
              >
                <option value="">-- 選擇標的 --</option>
                {assets.map(a => (
                  <option key={a.id} value={a.id}>
                    {a.ticker} ({MARKET_DATA[a.ticker]?.name || '未知'})
                  </option>
                ))}
              </select>
            </div>
          </div>

          {projection && (
            <div className="space-y-4">
              {/* CAGR 顯示 */}
              <div className="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                <div className="flex justify-between text-sm">
                  <span className="text-gray-400">回測年化報酬 (CAGR)</span>
                  <span className="text-emerald-400 font-bold">{projection.info.cagr}%</span>
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  * 根據歷史 5-10 年數據推算，不代表未來獲利。
                </div>
              </div>

              {/* 經理人點評卡片 */}
              {projection.review ? (
                <div className="bg-gradient-to-br from-blue-900/30 to-gray-900 p-5 rounded-xl border border-blue-500/30 relative overflow-hidden group">
                  <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity"><Award size={48}/></div>
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-blue-300 font-bold text-sm flex items-center">
                      <Activity size={14} className="mr-1"/> 經理人評級
                    </span>
                    <div className="flex text-yellow-400 text-xs">
                      {'★'.repeat(Math.floor(projection.review.rating))}
                      {projection.review.rating % 1 !== 0 && '½'}
                    </div>
                    <span className="text-xs text-gray-400 ml-auto border border-gray-600 px-2 rounded-full">{projection.review.tag}</span>
                  </div>
                  <p className="text-sm text-gray-300 leading-relaxed mb-3">
                    {projection.review.comment}
                  </p>
                  <div className="flex items-center text-xs text-gray-500 mt-2 border-t border-gray-700/50 pt-2">
                    <AlertTriangle size={12} className="mr-1 text-amber-500"/>
                    風險等級：<span className="text-amber-400 ml-1">{projection.review.risk}</span>
                  </div>
                </div>
              ) : (
                <div className="text-center p-4 text-gray-500 text-sm border border-dashed border-gray-700 rounded-lg">
                  尚無此標的之詳細評級報告
                </div>
              )}
            </div>
          )}

          <div>
             <label className="text-xs text-gray-400 uppercase font-semibold">持有年限: {years} 年</label>
             <input type="range" min="1" max="30" value={years} onChange={e=>setYears(+e.target.value)}
                className="w-full mt-2 accent-emerald-500 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" />
          </div>
        </div>

        {projection && (
          <div className="pt-6 border-t border-gray-700">
             <div className="text-sm text-gray-400 mb-1">預估 {years} 年後價值</div>
             <div className="text-3xl font-bold text-emerald-400">${formatMoney(projection.data[projection.data.length-1].amount)}</div>
             <div className="text-xs text-gray-500 mt-2">
               若不賣出，資產將翻 { (projection.data[projection.data.length-1].amount / projection.data[0].amount).toFixed(1) } 倍
             </div>
          </div>
        )}
      </div>

      <div className="lg:col-span-2 bg-gray-800 border border-gray-700 p-6 rounded-2xl flex flex-col">
        <h3 className="text-xl font-bold text-white mb-6">資產滾動曲線</h3>
        <div className="flex-1 min-h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            {projection ? (
              <AreaChart data={projection.data}>
                <defs>
                  <linearGradient id="colorAmount" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#10B981" stopOpacity={0.3}/>
                    <stop offset="95%" stopColor="#10B981" stopOpacity={0}/>
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" vertical={false} />
                <XAxis dataKey="year" stroke="#9CA3AF" tickLine={false} axisLine={false} label={{ value: '年後', position: 'insideBottomRight', offset: -5, fill: '#9CA3AF' }} />
                <YAxis stroke="#9CA3AF" tickLine={false} axisLine={false} tickFormatter={(val) => `$${val/10000}萬`} />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1F2937', borderColor: '#374151', color: '#fff' }}
                  formatter={(val) => [formatMoney(val), '價值']}
                  labelFormatter={(label) => `第 ${label} 年`}
                />
                <Area type="monotone" dataKey="amount" stroke="#10B981" strokeWidth={3} fillOpacity={1} fill="url(#colorAmount)" name="複利後資產" />
                <Area type="monotone" dataKey="principal" stroke="#6B7280" strokeWidth={2} strokeDasharray="5 5" fill="transparent" name="目前價值 (靜止)" />
              </AreaChart>
            ) : (
              <div className="flex flex-col items-center justify-center h-full text-gray-500">
                <PieChartIcon size={48} className="mb-4 opacity-20"/>
                請在左側選擇一支持股進行推演
              </div>
            )}
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  );
};

// --- 主程式 ---
export default function WealthPilotApp() {
  const [activeTab, setActiveTab] = useState('dashboard');
  
  // 使用 useStickyState 替代 useState 來實現 LocalStorage 存儲
  // 初始數據只在第一次加載時使用，之後會讀取 LocalStorage
  const [assets, setAssets] = useStickyState([
    { id: 1, ticker: '00631L', shares: 4000, cost: 214.44 },
    { id: 2, ticker: '00757', shares: 31585, cost: 81.18 },
    { id: 3, ticker: '00981', shares: 1000, cost: 10.47 },
    { id: 4, ticker: '2002', shares: 1000, cost: 18.75 }, 
    { id: 5, ticker: '2330', shares: 23, cost: 337.50 },
    { id: 6, ticker: '3033', shares: 1097, cost: 0 }, 
    { id: 7, ticker: 'COST', shares: 49.72635, cost: 506.09 },
    { id: 8, ticker: 'QQQ', shares: 15.01153, cost: 570.39 },
    { id: 9, ticker: 'NFLX', shares: 80, cost: 120.96 },
    { id: 10, ticker: 'FNGS', shares: 852, cost: 54.29 },
    { id: 11, ticker: 'XLG', shares: 41.0446, cost: 54.90 },
  ], 'wealthpilot-assets-v1');

  // 記帳紀錄也需要持久化
  const [records, setRecords] = useStickyState([], 'wealthpilot-records-v1');

  const handleAddAsset = (newAsset) => {
    setAssets([...assets, { ...newAsset, id: Date.now() }]);
  };

  const handleUpdateAsset = (updatedAsset) => {
    setAssets(assets.map(a => a.id === updatedAsset.id ? updatedAsset : a));
  };

  const handleDeleteAsset = (id) => {
    if(confirm('確定要刪除這筆持倉嗎？')) {
      setAssets(assets.filter(a => a.id !== id));
    }
  };

  return (
    <div className="min-h-screen bg-gray-950 text-gray-100 font-sans selection:bg-emerald-500/30">
      
      <aside className="fixed left-0 top-0 h-full w-64 bg-gray-900 border-r border-gray-800 hidden md:flex flex-col z-50">
        <div className="p-6 flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-900/20">
            <TrendingUp className="text-white" size={24} />
          </div>
          <div>
            <h1 className="text-xl font-bold text-white tracking-tight">WealthPilot</h1>
            <p className="text-xs text-gray-500">3.1 Ultimate</p>
          </div>
        </div>

        <nav className="flex-1 px-4 py-6 space-y-2">
          {[
            { id: 'dashboard', icon: LayoutDashboard, label: '投資戰情室' },
            { id: 'accounting', icon: Calendar, label: '每月收支 & 資產' },
            { id: 'compound', icon: Calculator, label: '持倉複利推演' },
          ].map(item => (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id)}
              className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all duration-200 group ${
                activeTab === item.id 
                ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-[0_0_15px_rgba(16,185,129,0.1)]' 
                : 'text-gray-400 hover:bg-gray-800 hover:text-white'
              }`}
            >
              <item.icon size={20} className={`transition-transform group-hover:scale-110 ${activeTab === item.id ? 'text-emerald-400' : ''}`} />
              <span className="font-medium">{item.label}</span>
              {activeTab === item.id && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse" />}
            </button>
          ))}
        </nav>
      </aside>

      <main className="md:ml-64 min-h-screen pb-20 md:pb-0">
        <header className="md:hidden bg-gray-900 border-b border-gray-800 p-4 sticky top-0 z-40 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center">
              <TrendingUp className="text-white" size={18} />
            </div>
            <span className="font-bold text-lg">WealthPilot</span>
          </div>
        </header>

        <div className="p-6 md:p-8 max-w-7xl mx-auto">
          {activeTab === 'dashboard' && (
            <Dashboard 
              assets={assets} 
              onAddAsset={handleAddAsset}
              onUpdateAsset={handleUpdateAsset}
              onDeleteAsset={handleDeleteAsset} 
            />
          )}
          {activeTab === 'accounting' && <MonthlyAccounting records={records} setRecords={setRecords} />}
          {activeTab === 'compound' && <CompoundCalc assets={assets} />}
        </div>
      </main>

      <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-gray-900/95 backdrop-blur border-t border-gray-800 z-50 px-6 py-2 flex justify-between safe-area-bottom">
        {[
          { id: 'dashboard', icon: LayoutDashboard, label: '總覽' },
          { id: 'accounting', icon: Calendar, label: '記帳' },
          { id: 'compound', icon: Calculator, label: '複利' },
        ].map(item => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex flex-col items-center gap-1 p-2 rounded-lg ${
              activeTab === item.id ? 'text-emerald-400' : 'text-gray-500'
            }`}
          >
            <item.icon size={24} />
            <span className="text-[10px] font-medium">{item.label}</span>
          </button>
        ))}
      </nav>
    </div>
  );
}